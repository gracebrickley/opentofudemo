# Atlantis repository configuration
# This file defines repository-level settings for Atlantis

# Workflow definitions (must be defined at server level when using --repo-config)
workflows:
  terragrunt:
    plan:
      steps:
        - run: |
            # Set OpenTofu version using tenv
            if command -v tenv &> /dev/null; then
              tenv tofu install $(cat .tenv.tofu.version 2>/dev/null || echo "1.8.8")
              tenv tofu use $(cat .tenv.tofu.version 2>/dev/null || echo "1.8.8")
            fi
        - run: terragrunt init -upgrade
        - run: terragrunt plan -input=false -out=$PLANFILE
    apply:
      steps:
        - run: |
            # Set OpenTofu version using tenv
            if command -v tenv &> /dev/null; then
              tenv tofu install $(cat .tenv.tofu.version 2>/dev/null || echo "1.8.8")
              tenv tofu use $(cat .tenv.tofu.version 2>/dev/null || echo "1.8.8")
            fi
        - run: terragrunt init -upgrade
        - run: terragrunt apply -input=false $PLANFILE
        
  opentofu:
    plan:
      steps:
        - run: |
            # Set OpenTofu version using tenv
            if command -v tenv &> /dev/null; then
              tenv tofu install $(cat .tenv.tofu.version 2>/dev/null || echo "1.8.8")
              tenv tofu use $(cat .tenv.tofu.version 2>/dev/null || echo "1.8.8")
            fi
        - run: tofu init -upgrade
        - run: tofu plan -input=false -out=$PLANFILE
    apply:
      steps:
        - run: |
            # Set OpenTofu version using tenv
            if command -v tenv &> /dev/null; then
              tenv tofu install $(cat .tenv.tofu.version 2>/dev/null || echo "1.8.8")
              tenv tofu use $(cat .tenv.tofu.version 2>/dev/null || echo "1.8.8")
            fi
        - run: tofu init -upgrade
        - run: tofu apply -input=false $PLANFILE

repos:
  - id: /.*/
    
    # Allow all commands by default for demo
    allowed_overrides:
      - apply_requirements
      - workflow
      - delete_source_branch_on_merge
    
    allowed_workflows:
      - terragrunt
      - opentofu
    
    # Enable auto planning
    allow_custom_workflows: true
    
    # Apply requirements
    apply_requirements:
      - approved
      - mergeable
    
    # Pre-workflow hooks
    pre_workflow_hooks:
      - run: |
          echo "=== Pre-workflow Hook ==="
          echo "Project: $PROJECT_NAME"
          echo "Directory: $DIR"
          echo "Workspace: $WORKSPACE"
          
          # Ensure tenv is available and install correct version
          if command -v tenv &> /dev/null; then
            cd $BASE_REPO_DIR
            if [ -f .tenv.tofu.version ]; then
              VERSION=$(cat .tenv.tofu.version)
              echo "Installing OpenTofu version: $VERSION"
              tenv tofu install $VERSION
              tenv tofu use $VERSION
            fi
          else
            echo "WARNING: tenv not found, skipping version management"
          fi
    
    # Post-workflow hooks
    post_workflow_hooks:
      - run: |
          echo "=== Post-workflow Hook ==="
          echo "Workflow completed for $PROJECT_NAME"

